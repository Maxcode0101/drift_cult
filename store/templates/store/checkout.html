{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>Checkout</h1>

<ul>
    {% for item in cart_items %}
    <li>{{ item.product_size.product.name }} ({{ item.product_size.size }}) - Qty: {{ item.quantity }}</li>
    {% endfor %}
</ul>

<p>Total: â‚¬{{ total }}</p>

<!-- Stripe Checkout Button -->
<form action="{% url 'create_checkout_session' %}" method="POST" id="checkout-form">
    {% csrf_token %}
    <button type="submit" id="checkout-button">Pay with Card</button>
</form>

<a href="{% url 'view_cart' %}">Back to Cart</a>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ stripe_public_key }}");

    const checkoutForm = document.getElementById("checkout-form");
    checkoutForm.addEventListener("submit", function (e) {
        e.preventDefault();
        fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            return stripe.redirectToCheckout({ sessionId: data.id });
        })
        .catch(error => console.error("Error:", error));
    });
</script>
{% endblock %}
